<html>
  <head>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/knockout/3.1.0/knockout-min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/knockout.mapping/2.4.1/knockout.mapping.min.js"></script>
    <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>

  </head>

  <body>
    <div data-bind="text: name"></div>
    <div>
      <div>Sum</div>
      <div data-bind="text: sum.sum"></div>
      <div data-bind="text: sum.sumInCurrency"></div>
    </div>
    <table border=1>
      <thead>
        <tr>
          <th>goodUuid</th>
          <th>quantity</th>
          <th>reserve</th>
          <th>price</th>
          <th>vat</th>
          <th>discount</th>
        </tr>
      </thead>
      <tbody data-bind="foreach: customerOrderPosition">
        <tr>
          <td data-bind="text: goodUuid"></td>
          <td data-bind="text: quantity"></td>
          <td data-bind="text: reserve"></td>
          <td data-bind="text: _price"></td>
          <td data-bind="text: vat"></td>
          <td data-bind="text: discount"></td>
        </tr>
      </tbody>
    </table>
  </body>

  <script>
    function createSumObject(options) {
      return ko.mapping.fromJS(
        options.data,
        {
          copy: ['TYPE_NAME']
        }
      );
    }

    function createCustomerOrderPosition(options) {
      console.log(options.data);
      koData = ko.mapping.fromJS(options.data, {
        basePrice: createSumObject,
        price: createSumObject,
        copy: [
          'TYPE_NAME',
          'accountId',
          'accountUuid',
          '//basePrice{}',
          'changeMode',
          'consignmentUuid',
          '//discount',
          '//goodUuid',
          '//price{}',
          '//quantity',
          'readMode',
          '//reserve',
          'uuid',
          '//vat',
        ]
      });

      koData._price = ko.computed(function(){
        return (this.price.sum()/100).toFixed(2);
      }, koData);

      return koData;
    }

    $(function(){
      var orderStr = '{"TYPE_NAME":"moysklad.customerOrder","reservedSum":53000,"targetAgentUuid":"123da6d2-0216-11e4-3a51-002590a28eca","sourceAgentUuid":"123fbe60-0216-11e4-4cbf-002590a28eca","sourceStoreUuid":"123f239f-0216-11e4-4d38-002590a28eca","applicable":true,"moment":"2014-07-13T18:10:00.000Z","targetAccountUuid":"123da933-0216-11e4-0b02-002590a28eca","sourceAccountUuid":"123fbfc2-0216-11e4-a9bc-002590a28eca","payerVat":true,"rate":1,"vatIncluded":true,"created":"2014-07-13T18:10:29.293Z","createdBy":"admin@ntts","name":"1405275025821","updated":"2014-07-15T19:16:50.080Z","updatedBy":"admin@ntts","readMode":"SELF","changeMode":"SELF","accountUuid":"122ed80b-0216-11e4-35ec-002590a28eca","accountId":"122ed80b-0216-11e4-35ec-002590a28eca","uuid":"f8d5a533-0ab8-11e4-5de1-002590a28eca","externalcode":"Yc5Z8sQ5i962j4-P7xBki3","sum":{"TYPE_NAME":"moysklad.moneyAmount","sum":157000,"sumInCurrency":157000},"customerOrderPosition":[{"TYPE_NAME":"moysklad.customerOrderPosition","discount":0,"quantity":1,"consignmentUuid":"21899f9d-02d7-11e4-76b8-002590a28eca","goodUuid":"2189996b-02d7-11e4-7401-002590a28eca","vat":18,"readMode":"SELF","changeMode":"SELF","accountUuid":"122ed80b-0216-11e4-35ec-002590a28eca","accountId":"122ed80b-0216-11e4-35ec-002590a28eca","uuid":"f8d5e552-0ab8-11e4-62bc-002590a28eca","basePrice":{"TYPE_NAME":"moysklad.moneyAmount","sum":25000,"sumInCurrency":25000},"price":{"TYPE_NAME":"moysklad.moneyAmount","sum":25000,"sumInCurrency":25000},"reserve":1},{"TYPE_NAME":"moysklad.customerOrderPosition","discount":0,"quantity":2,"consignmentUuid":"463d312a-02d7-11e4-b5ff-002590a28eca","goodUuid":"463d2a25-02d7-11e4-c44f-002590a28eca","vat":18,"readMode":"SELF","changeMode":"SELF","accountUuid":"122ed80b-0216-11e4-35ec-002590a28eca","accountId":"122ed80b-0216-11e4-35ec-002590a28eca","uuid":"f8d5e6dc-0ab8-11e4-209c-002590a28eca","basePrice":{"TYPE_NAME":"moysklad.moneyAmount","sum":28000,"sumInCurrency":28000},"price":{"TYPE_NAME":"moysklad.moneyAmount","sum":28000,"sumInCurrency":28000},"reserve":1},{"TYPE_NAME":"moysklad.customerOrderPosition","discount":0,"quantity":1,"consignmentUuid":"48ee1605-02d8-11e4-8f96-002590a28eca","goodUuid":"48ee1038-02d8-11e4-c052-002590a28eca","vat":18,"readMode":"SELF","changeMode":"SELF","accountUuid":"122ed80b-0216-11e4-35ec-002590a28eca","accountId":"122ed80b-0216-11e4-35ec-002590a28eca","uuid":"f8d5e7af-0ab8-11e4-aefb-002590a28eca","basePrice":{"TYPE_NAME":"moysklad.moneyAmount","sum":45000,"sumInCurrency":45000},"price":{"TYPE_NAME":"moysklad.moneyAmount","sum":45000,"sumInCurrency":45000},"reserve":0},{"TYPE_NAME":"moysklad.customerOrderPosition","discount":0,"quantity":1,"consignmentUuid":"8ace98e3-02d8-11e4-8aee-002590a28eca","goodUuid":"8ace9336-02d8-11e4-c2bc-002590a28eca","vat":18,"readMode":"SELF","changeMode":"SELF","accountUuid":"122ed80b-0216-11e4-35ec-002590a28eca","accountId":"122ed80b-0216-11e4-35ec-002590a28eca","uuid":"f8d5e86d-0ab8-11e4-bfe3-002590a28eca","basePrice":{"TYPE_NAME":"moysklad.moneyAmount","sum":14000,"sumInCurrency":14000},"price":{"TYPE_NAME":"moysklad.moneyAmount","sum":14000,"sumInCurrency":14000},"reserve":0},{"TYPE_NAME":"moysklad.customerOrderPosition","discount":0,"quantity":1,"consignmentUuid":"a090f753-02d8-11e4-96ac-002590a28eca","goodUuid":"a090f153-02d8-11e4-e210-002590a28eca","vat":18,"readMode":"SELF","changeMode":"SELF","accountUuid":"122ed80b-0216-11e4-35ec-002590a28eca","accountId":"122ed80b-0216-11e4-35ec-002590a28eca","uuid":"f8d5e91f-0ab8-11e4-a4c6-002590a28eca","basePrice":{"TYPE_NAME":"moysklad.moneyAmount","sum":12000,"sumInCurrency":12000},"price":{"TYPE_NAME":"moysklad.moneyAmount","sum":12000,"sumInCurrency":12000},"reserve":0},{"TYPE_NAME":"moysklad.customerOrderPosition","discount":0,"quantity":1,"consignmentUuid":"b7e314aa-02d8-11e4-6cc7-002590a28eca","goodUuid":"b7e30f42-02d8-11e4-c46e-002590a28eca","vat":18,"readMode":"SELF","changeMode":"SELF","accountUuid":"122ed80b-0216-11e4-35ec-002590a28eca","accountId":"122ed80b-0216-11e4-35ec-002590a28eca","uuid":"f8d5ea34-0ab8-11e4-9c38-002590a28eca","basePrice":{"TYPE_NAME":"moysklad.moneyAmount","sum":5000,"sumInCurrency":5000},"price":{"TYPE_NAME":"moysklad.moneyAmount","sum":5000,"sumInCurrency":5000},"reserve":0}]}';
      window.orderData = JSON.parse(orderStr);

      vm = ko.mapping.fromJS(orderData, {
        sum: {
          create: createSumObject
        },
        customerOrderPosition: {
          create: createCustomerOrderPosition
        },
        copy: [
          'TYPE_NAME',
          'accountId',
          'accountUuid',
          'applicable',
          'changeMode',
          'created',
          'createdBy',
          '//customerOrderPosition[]',
          'externalcode',
          'moment',
          '//name',
          'payerVat',
          'rate',
          'readMode',
          'sourceAccountUuid',
          'sourceAccountUuid',
          'sourceAgentUuid',
          'sourceStoreUuid',
          '//sum{}',
          'targetAccountUuid',
          'targetAgentUuid',
          'updated',
          'updatedBy',
          'uuid',
          'vatIncluded',
        ]
      }, {});

      ko.applyBindings(vm);
    });
  </script>

</html>
